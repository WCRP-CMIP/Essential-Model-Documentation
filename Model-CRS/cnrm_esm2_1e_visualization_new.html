<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNRM-ESM2-1e Model Structure</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            margin-top: 0;
            color: #333;
        }
        
        .info {
            background: #f0f7ff;
            border-left: 4px solid #0066cc;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .crs-string {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 16px;
            margin: 10px 0;
            word-break: break-all;
            line-height: 1.6;
            color: #333;
        }

        .crs-code {
            font-weight: bold;
            padding: 0px 2px;
            transition: all 0.2s ease;
        }

        .crs-bracket {
            color: #999;
        }

        .crs-code.highlighted {
            background: #ffff00;
            border-radius: 2px;
        }
        
        .viz-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin: 30px 0;
        }
        
        .viz-section {
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fafafa;
            padding: 20px;
        }
        
        .viz-section h3 {
            margin-top: 0;
            color: #333;
        }
        
        svg {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .node-circle {
            stroke: #fff;
            stroke-width: 2px;
            cursor: pointer;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
            transition: all 0.2s ease;
        }
        
        .node-circle:hover {
            stroke: #ffff00;
            stroke-width: 3px;
            filter: drop-shadow(0 2px 8px rgba(255,255,0,0.5));
        }

        .node-circle.highlighted {
            stroke: #ffff00;
            stroke-width: 3px;
            filter: drop-shadow(0 2px 8px rgba(255,255,0,0.5));
        }

        .embedded-circle {
            stroke: #aaa;
            stroke-width: 1.5px;
            filter: drop-shadow(0 1px 3px rgba(0,0,0,0.4));
            transition: all 0.2s ease;
        }
        
        .embedded-circle:hover {
            stroke: #ffff00;
            stroke-width: 2px;
            filter: drop-shadow(0 2px 6px rgba(255,255,0,0.4));
        }

        .embedded-circle.highlighted {
            stroke: #ffff00;
            stroke-width: 2px;
            filter: drop-shadow(0 2px 6px rgba(255,255,0,0.4));
        }
        
        .node-label {
            font-size: 12px;
            font-weight: bold;
            text-anchor: middle;
            pointer-events: none;
            fill: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .embedded-label {
            font-size: 10px;
        }
        
        .link-couple {
            stroke: #4ecdc4;
            stroke-width: 2px;
            stroke-dasharray: 5,5;
            marker-end: url(#arrowcouple);
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.95);
            color: white;
            padding: 14px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 360px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
        }

        .tooltip.show {
            display: block;
        }

        .tooltip-title {
            font-weight: bold;
            margin-bottom: 8px;
            border-bottom: 1px solid #666;
            padding-bottom: 8px;
            font-size: 13px;
        }

        .tooltip-line {
            margin: 6px 0;
            word-break: break-word;
            line-height: 1.4;
            font-size: 11px;
        }

        .tooltip-label {
            color: #aaa;
            text-transform: uppercase;
            display: inline-block;
            width: 60px;
        }

        .tooltip-value {
            color: #fff;
            font-weight: bold;
        }

        .tooltip-model {
            color: #4ecdc4;
        }

        .tooltip-grid {
            color: #f4a261;
        }
        
        .summary-box {
            background: #f0f7ff;
            border-left: 4px solid #0066cc;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .summary-box h4 {
            margin-top: 0;
            color: #0066cc;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .component-card {
            background: white;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #999;
            display: flex;
            flex-direction: column;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .component-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .component-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .component-title {
            font-weight: bold;
            font-size: 13px;
        }

        .component-name {
            font-weight: normal;
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }

        .status-tags {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .status-tag {
            background: #d4edda;
            color: #155724;
            padding: 2px 5px;
            border-radius: 2px;
            font-size: 8px;
            font-weight: bold;
            white-space: nowrap;
        }

        .embedded-badge {
            background: #ff6b6b;
            color: white;
            padding: 2px 4px;
            border-radius: 2px;
            font-size: 8px;
            font-weight: bold;
            white-space: nowrap;
        }

        .component-model {
            background: #f0f7ff;
            padding: 4px 6px;
            border-radius: 2px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 10px;
            color: #0066cc;
            font-weight: bold;
        }

        .component-grids {
            display: flex;
            gap: 5px;
            font-size: 8px;
        }

        .grid-badge {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 2px;
            color: #856404;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CNRM-ESM2-1e Model Structure</h1>
        
        <div class="info">
            <strong>Canonical Realm String (CRS):</strong>
            <div class="crs-string" id="crs-output"></div>
        </div>
        
        <div class="legend" id="legend-container"></div>
        <div class="legend">
            <div class="legend-item">
                <div style="width: 30px; height: 3px; background: #ff6b6b;"></div>
                <span>Embedding (child inside parent)</span>
            </div>
            <div class="legend-item">
                <div style="width: 30px; height: 2px; background: #4ecdc4; background-image: linear-gradient(90deg, #4ecdc4 50%, transparent 50%); background-size: 10px 2px;"></div>
                <span>Coupling (bidirectional)</span>
            </div>
        </div>

        <div class="viz-container">
            <div class="viz-section">
                <h3>Model Structure (Force-Directed Coupling with Circle-Packed Embeddings)</h3>
                <div id="tooltip" class="tooltip"></div>
                <svg id="force-graph"></svg>
            </div>
        </div>

        <div class="summary-box">
            <h4>Component Configurations</h4>
            <div class="summary-grid" id="components-summary"></div>
        </div>
    </div>

    <script>
        const realmColors = {
            'O': '#264653',
            'Ob': '#287271',
            'Si': '#2a9d8f',
            'L': '#8ab17d',
            'Li': '#7cadbe',
            'Ae': '#e9c46a',
            'Ac': '#f4a261',
            'A': '#e76f51'
        };

        const codeMap = {
            'atmosphere': 'A',
            'ocean': 'O',
            'land-surface': 'L',
            'atmospheric-chemistry': 'Ac',
            'aerosol': 'Ae',
            'land-ice': 'Li',
            'ocean-biogeochemistry': 'Ob',
            'sea-ice': 'Si'
        };

        const nameMap = Object.fromEntries(Object.entries(codeMap).map(([k, v]) => [v, k]));

        const componentConfigs = [
            { realm: 'A', name: 'atmosphere', model: 'arpege-climat-version-6-3', h: 'h100', v: 'v100', status: 'dynamic', embedded: false },
            { realm: 'L', name: 'land-surface', model: 'surfex-v8-modeling-platform', h: 'h100', v: 'v102', status: 'dynamic', embedded: false },
            { realm: 'O', name: 'ocean', model: 'nemo-v3-6', h: 'h101', v: 'v103', status: 'dynamic', embedded: false },
            { realm: 'Ae', name: 'aerosol', model: 'tactic', h: 'h100', v: 'v100', status: 'dynamic', embedded: true },
            { realm: 'Ac', name: 'atmospheric-chemistry', model: 'reprobus-c-v2-0', h: 'h100', v: 'v100', status: 'dynamic', embedded: true },
            { realm: 'Si', name: 'sea-ice', model: 'gelato', h: 'h101', v: 'v104', status: 'dynamic', embedded: true },
            { realm: 'Ob', name: 'ocean-biogeochemistry', model: 'piscesv2-gas', h: 'h101', v: 'v103', status: 'dynamic', embedded: true }
        ];

        const configMap = new Map(componentConfigs.map(c => [c.realm, c]));

        const embeddings = [
            ['Ae', 'A'],
            ['Ac', 'A'],
            ['Si', 'O'],
            ['Ob', 'O']
        ];

        const couplings = [
            ['A', 'L'],
            ['A', 'O'],
            ['L', 'O']
        ];

        const allCodes = new Set([...embeddings.flat(), ...couplings.flat()]);
        const parentMap = new Map(embeddings);
        const childrenMap = new Map();
        embeddings.forEach(([c, p]) => {
            if (!childrenMap.has(p)) childrenMap.set(p, []);
            childrenMap.get(p).push(c);
        });

        const rootNodes = Array.from(allCodes).filter(code => !parentMap.has(code)).map(code => {
            const configInfo = configMap.get(code);
            return {
                id: code,
                name: nameMap[code],
                color: realmColors[code],
                model: configInfo?.model || '',
                hGrid: configInfo?.h || '',
                vGrid: configInfo?.v || '',
                status: configInfo?.status || ''
            };
        });

        const embeddedNodes = Array.from(allCodes).filter(code => parentMap.has(code)).map(code => {
            const configInfo = configMap.get(code);
            return {
                id: code,
                name: nameMap[code],
                color: realmColors[code],
                model: configInfo?.model || '',
                hGrid: configInfo?.h || '',
                vGrid: configInfo?.v || '',
                status: configInfo?.status || ''
            };
        });

        const allNodes = [...rootNodes, ...embeddedNodes];
        const couplingLinks = couplings.map(([c1, c2]) => ({ source: c1, target: c2 }));

        function generateCRSHTML() {
            const crs = 'A[AeAc](L,O)L(O)O[SiOb]';
            let html = '';
            let i = 0;
            while (i < crs.length) {
                if (i + 1 < crs.length) {
                    const twoChar = crs.substring(i, i + 2);
                    if (realmColors[twoChar]) {
                        html += `<span class="crs-code" style="color: ${realmColors[twoChar]};">${twoChar}</span>`;
                        i += 2;
                        continue;
                    }
                }
                const char = crs[i];
                if (realmColors[char]) {
                    html += `<span class="crs-code" style="color: ${realmColors[char]};">${char}</span>`;
                } else {
                    html += `<span class="crs-bracket">${char}</span>`;
                }
                i++;
            }
            return html;
        }

        document.getElementById('crs-output').innerHTML = generateCRSHTML();

        const legend = document.getElementById('legend-container');
        Array.from(allCodes).sort().forEach(code => {
            const item = document.createElement('div');
            item.className = 'legend-item';
            item.innerHTML = `
                <div class="legend-color" style="background: ${realmColors[code]};"></div>
                <span><strong>${code}</strong> - ${nameMap[code]}</span>
            `;
            legend.appendChild(item);
        });

        const summary = document.getElementById('components-summary');
        componentConfigs.forEach(config => {
            const card = document.createElement('div');
            card.className = 'component-card';
            card.style.borderLeftColor = realmColors[config.realm];
            card.dataset.code = config.realm;
            
            const statusHTML = config.status ? `<span class="status-tag">${config.status.toUpperCase()}</span>` : '';
            const embeddedHTML = config.embedded ? `<span class="embedded-badge">E</span>` : '';
            
            card.innerHTML = `
                <div class="component-header">
                    <div class="component-title">${config.realm}</div>
                    <div class="status-tags">
                        ${statusHTML}
                        ${embeddedHTML}
                    </div>
                </div>
                <div class="component-name">${config.name}</div>
                <div class="component-model">${config.model}</div>
                <div class="component-grids">
                    <span class="grid-badge">H: ${config.h}</span>
                    <span class="grid-badge">V: ${config.v}</span>
                </div>
            `;
            
            card.addEventListener('mouseenter', function() {
                const code = this.dataset.code;
                d3.selectAll('.node-circle').classed('highlighted', d => d.id === code);
                d3.selectAll('.embedded-circle').classed('highlighted', d => d.id === code);
                const crsContainer = document.getElementById('crs-output');
                Array.from(crsContainer.querySelectorAll('.crs-code')).forEach(el => {
                    if (el.textContent === code) {
                        el.classList.add('highlighted');
                    }
                });
            });
            
            card.addEventListener('mouseleave', function() {
                d3.selectAll('.node-circle').classed('highlighted', false);
                d3.selectAll('.embedded-circle').classed('highlighted', false);
                const crsContainer = document.getElementById('crs-output');
                Array.from(crsContainer.querySelectorAll('.crs-code')).forEach(el => {
                    el.classList.remove('highlighted');
                });
            });
            
            summary.appendChild(card);
        });

        const width = 1000;
        const height = 600;
        const parentRadius = 50;
        const childRadius = 25;
        const circlePacking = 12;

        const svg = d3.select('#force-graph')
            .attr('viewBox', `0 0 ${width} ${height}`)
            .style('background', '#fafafa');

        svg.append('defs').selectAll('marker')
            .data(['arrowcouple'])
            .enter()
            .append('marker')
            .attr('id', d => d)
            .attr('markerWidth', 10)
            .attr('markerHeight', 10)
            .attr('refX', 25)
            .attr('refY', 3)
            .attr('orient', 'auto')
            .append('polygon')
            .attr('points', '0 0, 10 3, 0 6')
            .attr('fill', '#4ecdc4');

        const simulation = d3.forceSimulation(rootNodes)
            .force('link', d3.forceLink(couplingLinks)
                .id(d => typeof d === 'string' ? d : d.id)
                .distance(150)
            )
            .force('charge', d3.forceManyBody().strength(-800))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide(parentRadius + 20));

        const coupleLink = svg.selectAll('.link-couple')
            .data(couplingLinks)
            .enter()
            .append('line')
            .attr('class', 'link-couple');

        const tooltip = d3.select('#tooltip');

        function showTooltip(event, d) {
            const statusLine = d.status ? `<div class="tooltip-line"><span class="tooltip-label">Status:</span> <span class="tooltip-value">${d.status.toUpperCase()}</span></div>` : '';
            tooltip.html(`
                <div class="tooltip-title">${d.id} - ${d.name}</div>
                ${statusLine}
                <div class="tooltip-line"><span class="tooltip-label">Model:</span> <span class="tooltip-model">${d.model}</span></div>
                <div class="tooltip-line"><span class="tooltip-label">Grids:</span> <span class="tooltip-grid">H: ${d.hGrid} | V: ${d.vGrid}</span></div>
            `)
            .classed('show', true)
            .style('left', (event.pageX + 10) + 'px')
            .style('top', (event.pageY - 10) + 'px');
        }

        function hideTooltip() {
            tooltip.classed('show', false);
        }

        const parentNode = svg.selectAll('.parent-node')
            .data(rootNodes)
            .enter()
            .append('circle')
            .attr('class', 'node-circle')
            .attr('r', parentRadius)
            .attr('fill', d => d.color)
            .on('mouseover', showTooltip)
            .on('mouseout', hideTooltip)
            .call(d3.drag()
                .on('start', dragStarted)
                .on('drag', dragged)
                .on('end', dragEnded));

        const parentLabel = svg.selectAll('.parent-label')
            .data(rootNodes)
            .enter()
            .append('text')
            .attr('class', 'node-label')
            .style('font-size', '14px')
            .text(d => d.id);

        const embeddedNode = svg.selectAll('.embedded-node')
            .data(embeddedNodes)
            .enter()
            .append('circle')
            .attr('class', 'embedded-circle')
            .attr('r', childRadius)
            .attr('fill', d => d.color)
            .on('mouseover', showTooltip)
            .on('mouseout', hideTooltip);

        const embeddedLabel = svg.selectAll('.embedded-label')
            .data(embeddedNodes)
            .enter()
            .append('text')
            .attr('class', 'node-label embedded-label')
            .text(d => d.id);

        simulation.on('tick', () => {
            rootNodes.forEach(d => {
                d.x = Math.max(parentRadius, Math.min(width - parentRadius, d.x));
                d.y = Math.max(parentRadius, Math.min(height - parentRadius, d.y));
            });

            coupleLink
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

            parentNode
                .attr('cx', d => d.x)
                .attr('cy', d => d.y);

            parentLabel
                .attr('x', d => d.x)
                .attr('y', d => d.y + 5);

            embeddedNode.each(function(d) {
                const parent = rootNodes.find(n => n.id === parentMap.get(d.id));
                if (parent) {
                    const siblings = parent.children || [];
                    const index = siblings.indexOf(d.id);
                    const totalSiblings = siblings.length;
                    
                    const angle = (index / totalSiblings) * Math.PI * 2;
                    const packDistance = parentRadius - childRadius - circlePacking;
                    
                    d.x = parent.x + Math.cos(angle) * packDistance;
                    d.y = parent.y + Math.sin(angle) * packDistance;
                }
            });

            embeddedNode
                .attr('cx', d => d.x)
                .attr('cy', d => d.y);

            embeddedLabel
                .attr('x', d => d.x)
                .attr('y', d => d.y + 4);
        });

        rootNodes.forEach(node => {
            node.children = childrenMap.get(node.id) || [];
        });

        function dragStarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragEnded(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    </script>
</body>
</html>
