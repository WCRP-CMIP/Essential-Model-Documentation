
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Source Code Pro', monospace; background: #ffffff;
         display: flex; flex-direction: column; align-items: center;
         padding: 24px 24px 40px; }
  #chart { position: relative; }
  .tip {
    position: fixed; background: #0d1035; color: #fff;
    padding: 10px 14px; border-radius: 8px; font-size: 12px;
    font-family: 'Source Code Pro', monospace; pointer-events: none;
    opacity: 0; transition: opacity .12s; line-height: 1.9;
    box-shadow: 0 6px 24px rgba(0,0,0,.25); max-width: 240px;
  }
  .tip .tip-link { color: #e8607e; font-weight: 600; }
  .tip .tip-text { color: #f5c842; font-weight: 600; }
  .tip .tip-head { font-weight: 700; font-size: 13px;
                   border-bottom: 1px solid rgba(255,255,255,.2);
                   padding-bottom: 5px; margin-bottom: 5px; }
</style>
</head>
<body>
<div id="chart"></div>
<div class="tip" id="tip"></div>

<script>
const D = {"ids": ["g101", "g106", "g105", "g102", "g104", "g100", "g103"], "link": [[0.0, 0.6, 0.6, 0.6, 0.7, 0.7, 0.21428571428571427], [0.6, 0.0, 1.0, 1.0, 0.6666666666666666, 0.6666666666666666, 0.25], [0.6, 1.0, 0.0, 1.0, 0.6666666666666666, 0.6666666666666666, 0.25], [0.6, 1.0, 1.0, 0.0, 0.6666666666666666, 0.6666666666666666, 0.25], [0.7, 0.6666666666666666, 0.6666666666666666, 0.6666666666666666, 0.0, 1.0, 0.23076923076923078], [0.7, 0.6666666666666666, 0.6666666666666666, 0.6666666666666666, 1.0, 0.0, 0.23076923076923078], [0.21428571428571427, 0.25, 0.25, 0.25, 0.23076923076923078, 0.23076923076923078, 0.0]], "text": [[0.0, 0.3518317937850952, 0.34419557452201843, 0.49598193168640137, 0.4234781563282013, 0.46865156292915344, 0.10285606235265732], [0.3518317937850952, 0.0, 0.8352095484733582, 0.7631481289863586, 0.456768661737442, 0.44800615310668945, 0.1718309223651886], [0.34419557452201843, 0.8352095484733582, 0.0, 0.7949780225753784, 0.45669880509376526, 0.45308321714401245, 0.2263585776090622], [0.49598193168640137, 0.7631481289863586, 0.7949780225753784, 0.0, 0.5293184518814087, 0.5561655759811401, 0.29181236028671265], [0.4234781563282013, 0.456768661737442, 0.45669880509376526, 0.5293184518814087, 0.0, 0.8995537161827087, 0.37728697061538696], [0.46865156292915344, 0.44800615310668945, 0.45308321714401245, 0.5561655759811401, 0.8995537161827087, 0.0, 0.4044671356678009], [0.10285606235265732, 0.1718309223651886, 0.2263585776090622, 0.29181236028671265, 0.37728697061538696, 0.4044671356678009, 0.0]], "method": "embedding (all-MiniLM-L6-v2)", "folder": "emd:horizontal_grid_cells"};
const { ids, link, text, method, folder } = D;

const n = ids.length;
// Smaller cells — fit comfortably in a notebook output
const cellSize = Math.min(60, Math.floor(Math.min(window.innerWidth * 0.72, 480) / n));
const gap      = Math.max(2, Math.round(cellSize * 0.055));
const inner    = cellSize - gap;
const radius   = Math.round(inner * 0.14);
const FONT     = "'Source Code Pro', monospace";

const TITLE_H = 54;   // title + subtitle
const XLBL_H  = Math.round(cellSize * 0.55); // horizontal x-axis label strip
const LEG_H   = 58;   // gradient legend bars
const margin  = { top: TITLE_H, right: 20,
                  bottom: XLBL_H + LEG_H + 24,
                  left: Math.round(cellSize * 0.88) };

const W = n * cellSize + margin.left + margin.right;
const H = n * cellSize + margin.top  + margin.bottom;

const RED     = '#a40e4C';
const MUSTARD = '#f2b30d';
const NAVY    = '#0d1035';
const WHITE   = '#ffffff';

function hexToRgb(h) {
  return [parseInt(h.slice(1,3),16)/255, parseInt(h.slice(3,5),16)/255, parseInt(h.slice(5,7),16)/255];
}
function blend(hex, a) {
  const [r,g,b] = hexToRgb(hex);
  return `rgb(${Math.round((1-a+r*a)*255)},${Math.round((1-a+g*a)*255)},${Math.round((1-a+b*a)*255)})`;
}

const svg = d3.select('#chart').append('svg').attr('width', W).attr('height', H);
const defs = svg.append('defs');

// Gradient defs for legend bars
[['leg-red', RED], ['leg-mustard', MUSTARD]].forEach(([id, col]) => {
  const gr = defs.append('linearGradient').attr('id', id).attr('x1','0%').attr('x2','100%');
  gr.append('stop').attr('offset','0%').attr('stop-color', WHITE);
  gr.append('stop').attr('offset','100%').attr('stop-color', col);
});

// Title (inside SVG, above matrix)
svg.append('text')
  .attr('x', W/2).attr('y', 24)
  .attr('text-anchor','middle').attr('font-family', FONT)
  .attr('font-size', 17).attr('font-weight', 700).attr('fill', NAVY)
  .text('Grid Cell Similarity Matrix');
svg.append('text')
  .attr('x', W/2).attr('y', 41)
  .attr('text-anchor','middle').attr('font-family', FONT)
  .attr('font-size', 9).attr('fill','#999')
  .text(folder + '  ·  ' + n + ' items  ·  spectrally ordered  ·  ' + method);

const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);
const tip = d3.select('#tip');

// ── Cells ──────────────────────────────────────────────────────────────────
const cellData = [];
for (let i=0;i<n;i++) for (let j=0;j<n;j++) cellData.push({i,j});

g.selectAll('.cell').data(cellData).join('rect')
  .attr('class','cell')
  .attr('x',      d => d.j*cellSize + gap/2)
  .attr('y',      d => d.i*cellSize + gap/2)
  .attr('width',  inner).attr('height', inner).attr('rx', radius)
  .attr('fill', d => {
    if (d.i===d.j) return NAVY;
    return d.i < d.j ? blend(RED, link[d.i][d.j]) : blend(MUSTARD, text[d.i][d.j]);
  })
  .style('cursor', d => d.i===d.j ? 'default' : 'pointer')
  .on('mouseover', function(event, d) {
    if (d.i===d.j) return;
    const li=Math.min(d.i,d.j), lj=Math.max(d.i,d.j);
    tip.style('opacity',1).html(
      `<div class="tip-head">${ids[d.i]} ↔ ${ids[d.j]}</div>` +
      `<span class="tip-link">▲ Link</span>&nbsp; ${(link[li][lj]*100).toFixed(1)}%<br>` +
      `<span class="tip-text">▼ Content</span>&nbsp; ${(text[lj][li]*100).toFixed(1)}%`
    );
    d3.select(this).attr('stroke',NAVY).attr('stroke-width',2);
    g.selectAll('.cell').filter(e => e.i!==d.i && e.j!==d.j).attr('opacity',0.35);
  })
  .on('mousemove', ev => tip.style('left',(ev.clientX+14)+'px').style('top',(ev.clientY-10)+'px'))
  .on('mouseout', function() {
    tip.style('opacity',0);
    d3.select(this).attr('stroke','none');
    g.selectAll('.cell').attr('opacity',1);
  });

// ── Value labels inside cells ───────────────────────────────────────────────
g.selectAll('.val').data(cellData.filter(d=>d.i!==d.j)).join('text')
  .attr('class','val')
  .attr('x', d => d.j*cellSize + cellSize/2)
  .attr('y', d => d.i*cellSize + cellSize/2)
  .attr('dy','0.35em').attr('text-anchor','middle')
  .attr('font-family', FONT)
  .attr('font-size', Math.max(8, Math.round(cellSize*0.16)))
  .attr('font-weight',600).attr('pointer-events','none')
  .attr('fill', d => {
    const v = d.i<d.j ? link[d.i][d.j] : text[d.i][d.j];
    if (v<0.08) return 'none';
    const [r,gg,b] = hexToRgb(d.i<d.j ? RED : MUSTARD);
    return (0.299*(1-v+r*v) + 0.587*(1-v+gg*v) + 0.114*(1-v+b*v)) < 0.55 ? WHITE : NAVY;
  })
  .text(d => { const v=d.i<d.j?link[d.i][d.j]:text[d.i][d.j]; return v>=0.08?Math.round(v*100)+'%':''; });

// ── Diagonal labels ─────────────────────────────────────────────────────────
g.selectAll('.diag').data(ids).join('text')
  .attr('class','diag')
  .attr('x', (d,i) => i*cellSize+cellSize/2)
  .attr('y', (d,i) => i*cellSize+cellSize/2)
  .attr('dy','0.35em').attr('text-anchor','middle')
  .attr('font-family', FONT)
  .attr('font-size', Math.max(9, Math.round(cellSize*0.18)))
  .attr('font-weight',700).attr('fill',WHITE).attr('pointer-events','none')
  .text(d=>d);

// ── Axis labels (horizontal) ─────────────────────────────────────────────────
const lblFs = Math.max(10, Math.round(cellSize*0.17));

// X-axis — horizontal labels below matrix
g.selectAll('.xlabel').data(ids).join('text')
  .attr('class','xlabel')
  .attr('x', (d,i) => i*cellSize+cellSize/2)
  .attr('y', n*cellSize + Math.round(cellSize*0.26))
  .attr('text-anchor','middle').attr('dominant-baseline','hanging')
  .attr('font-family', FONT).attr('font-size', lblFs)
  .attr('font-weight',600).attr('fill', NAVY)
  .text(d=>d);

// Y-axis labels — left side
g.selectAll('.ylabel').data(ids).join('text')
  .attr('class','ylabel')
  .attr('x', -Math.round(cellSize*0.16))
  .attr('y', (d,i) => i*cellSize+cellSize/2)
  .attr('text-anchor','end').attr('dominant-baseline','middle')
  .attr('font-family', FONT).attr('font-size', lblFs)
  .attr('font-weight',600).attr('fill', NAVY)
  .text(d=>d);

// Diagonal divider line
g.append('line')
  .attr('x1',0).attr('y1',0).attr('x2',n*cellSize).attr('y2',n*cellSize)
  .attr('stroke',NAVY).attr('stroke-width',1.5)
  .attr('stroke-dasharray','5,4').attr('opacity',0.22);

// ── Legend — gradient bars at the bottom ──────────────────────────────────────
const legY   = n*cellSize + XLBL_H + 22;  // y-position inside g group
const barW   = Math.floor(n*cellSize * 0.43);
const barH   = 13;
const legFs  = Math.max(9, Math.round(cellSize * 0.16));

// Red bar — left side
g.append('text')
  .attr('x',0).attr('y', legY-8)
  .attr('text-anchor','start').attr('font-family', FONT)
  .attr('font-size', legFs).attr('font-weight',700).attr('fill', RED)
  .text('▲  link similarity');
g.append('rect')
  .attr('x',0).attr('y', legY)
  .attr('width', barW).attr('height', barH)
  .attr('rx',3).attr('fill','url(#leg-red)');
g.append('text').attr('x',0).attr('y', legY+barH+9)
  .attr('text-anchor','start').attr('font-size', legFs-1)
  .attr('fill','#bbb').attr('font-family', FONT).text('0%');
g.append('text').attr('x', barW).attr('y', legY+barH+9)
  .attr('text-anchor','end').attr('font-size', legFs-1)
  .attr('fill','#bbb').attr('font-family', FONT).text('100%');

// Mustard bar — right side
const mustX = n*cellSize - barW;
g.append('text')
  .attr('x', mustX).attr('y', legY-8)
  .attr('text-anchor','start').attr('font-family', FONT)
  .attr('font-size', legFs).attr('font-weight',700).attr('fill','#c49000')
  .text('▼  content similarity');
g.append('rect')
  .attr('x', mustX).attr('y', legY)
  .attr('width', barW).attr('height', barH)
  .attr('rx',3).attr('fill','url(#leg-mustard)');
g.append('text').attr('x', mustX).attr('y', legY+barH+9)
  .attr('text-anchor','start').attr('font-size', legFs-1)
  .attr('fill','#bbb').attr('font-family', FONT).text('0%');
g.append('text').attr('x', mustX+barW).attr('y', legY+barH+9)
  .attr('text-anchor','end').attr('font-size', legFs-1)
  .attr('fill','#bbb').attr('font-family', FONT).text('100%');

// Hover hint
g.append('text')
  .attr('x', n*cellSize/2).attr('y', legY+barH+28)
  .attr('text-anchor','middle').attr('font-size', 9)
  .attr('font-family', FONT).attr('fill','#ccc')
  .text('hover any cell for details');

</script>
</body></html>
