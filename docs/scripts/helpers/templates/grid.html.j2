{% extends "base.html.j2" %}

{% block title %}{{ name | e }} | {{ page_type }}{% endblock %}

{% block head_extra %}
<style>
/* ── Hero stat numbers ──────────────────────────────────────── */
.hero-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin: 1.25rem 0 0.5rem;
}
.hero-stat {
    background: var(--emd-bg);
    border: 1px solid var(--emd-border);
    border-radius: var(--emd-radius);
    padding: 0.85rem 1.25rem;
    min-width: 130px;
    text-align: center;
}
.hero-stat-value {
    font-size: 2rem;
    font-weight: 800;
    color: var(--emd-primary);
    font-family: 'SF Mono', Monaco, monospace;
    line-height: 1;
    margin-bottom: 0.25rem;
}
.hero-stat-label {
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--emd-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.07em;
}
/* ── Plain-language callout ─────────────────────────────────── */
.plain-summary {
    background: rgba(37,99,235,0.05);
    border-radius: var(--emd-radius);
    padding: 1rem 1.25rem;
    margin-bottom: 1.25rem;
    font-size: 0.95rem;
    line-height: 1.7;
}
.plain-summary strong { color: var(--emd-primary); }
/* ── Arrangement card ───────────────────────────────────────── */
.arr-card {
    background: var(--emd-bg);
    border: 1px solid var(--emd-border);
    border-radius: var(--emd-radius);
    padding: 1rem 1.25rem;
}
.arr-name { font-size: 1rem; font-weight: 600; color: var(--emd-text); margin-bottom: 0.4rem; }
.arr-desc { font-size: 0.875rem; color: var(--emd-secondary); line-height: 1.6; }
/* ── Grid cells info box ────────────────────────────────────── */
.gc-info {
    background: var(--emd-surface);
    border: 1px solid var(--emd-border);
    border-radius: var(--emd-radius);
    padding: 0.85rem 1rem;
    margin-top: 0.75rem;
    font-size: 0.875rem;
}
.gc-info-title {
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--emd-text-muted);
    margin-bottom: 0.5rem;
}
.gc-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem 1.25rem;
}
.gc-stat { display: flex; flex-direction: column; }
.gc-stat-label {
    font-size: 0.68rem;
    color: var(--emd-text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}
.gc-stat-value {
    font-family: 'SF Mono', Monaco, monospace;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--emd-text);
}
.gc-stat-value.highlight { color: var(--emd-primary); }
.tag-row { display: flex; flex-wrap: wrap; gap: 0.35rem; margin: 0.5rem 0 0; }
.cv-tag {
    font-size: 0.72rem;
    padding: 0.15rem 0.5rem;
    border-radius: 9999px;
    border: 1px solid var(--emd-border);
    color: var(--emd-text-muted);
    cursor: default;
}
.cv-tag[title] { cursor: help; }
.cv-tag.primary { border-color: var(--emd-primary); color: var(--emd-primary); background: rgba(37,99,235,0.07); }
/* ── Vertical level visualiser ──────────────────────────────── */
.vg-visual {
    margin: 0.75rem 0 1.25rem;
}
.vg-bar-wrap {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    height: 56px;
}
.vg-bar {
    flex: 1;
    background: var(--emd-primary);
    border-radius: 3px 3px 0 0;
    min-width: 3px;
}
.vg-bar-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.68rem;
    color: var(--emd-text-muted);
    margin-top: 3px;
}
/* ── Level stat grid ────────────────────────────────────────── */
.level-stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}
.level-stat {
    background: var(--emd-bg);
    border: 1px solid var(--emd-border);
    border-radius: var(--emd-radius);
    padding: 1rem;
    text-align: center;
}
.level-stat-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--emd-primary);
    font-family: 'SF Mono', Monaco, monospace;
    line-height: 1;
    margin-bottom: 0.25rem;
}
.level-stat-label {
    font-size: 0.72rem;
    color: var(--emd-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.06em;
}
</style>
{% endblock %}

{% block breadcrumb_extra %}
<span>→</span>
<span>{{ page_type }}</span>
<span>→</span>
<span>{{ name | e }}</span>
{% endblock %}

{% block page_header %}
<div class="emd-badge">{{ page_type }}</div>
<h1 class="emd-title">{{ name | e }}</h1>
{% if validation_key and validation_key != name %}
<p class="emd-long-name">{{ validation_key | e }}</p>
{% endif %}
<p class="emd-subtitle">{{ description | e }}</p>

{# Hero stats strip in header #}
{% if arrangement or n_z or subgrids %}
<div class="hero-stats">
    {% if arrangement %}
    <div class="hero-stat">
        <div class="hero-stat-value" style="font-size:1.1rem;">{{ arrangement.name | e }}</div>
        <div class="hero-stat-label">Grid Arrangement</div>
    </div>
    {% endif %}
    {% if subgrids %}
    <div class="hero-stat">
        <div class="hero-stat-value">{{ subgrids | length }}</div>
        <div class="hero-stat-label">Subgrid{{ 's' if subgrids|length != 1 }}</div>
    </div>
    {% for sg in subgrids if sg.grid_cells and sg.grid_cells.n_cells %}
    <div class="hero-stat">
        <div class="hero-stat-value" style="font-size:1.3rem;">{{ "{:,}".format(sg.grid_cells.n_cells) }}</div>
        <div class="hero-stat-label">{{ sg.name | e }} Cells</div>
    </div>
    {% endfor %}
    {% if subgrids[0].grid_cells and subgrids[0].grid_cells.x_resolution %}
    <div class="hero-stat">
        <div class="hero-stat-value" style="font-size:1.3rem;">{{ subgrids[0].grid_cells.x_resolution }}°</div>
        <div class="hero-stat-label">Horiz. Resolution</div>
    </div>
    {% endif %}
    {% endif %}
    {% if n_z %}
    <div class="hero-stat">
        <div class="hero-stat-value">{{ n_z }}</div>
        <div class="hero-stat-label">Vertical Levels</div>
    </div>
    {% endif %}
    {% if total_thickness %}
    <div class="hero-stat">
        <div class="hero-stat-value" style="font-size:1.2rem;">{{ "{:,.0f}".format(total_thickness) }}&thinsp;m</div>
        <div class="hero-stat-label">Total Depth</div>
    </div>
    {% endif %}
</div>
{% endif %}

<div class="emd-header-meta">
    {% if arrangement %}
    <div class="emd-meta-item">
        <span class="emd-meta-label">Arrangement</span>
        <span class="emd-meta-value" title="{{ arrangement.description | e }}">{{ arrangement.name | e }}</span>
    </div>
    {% endif %}
    {% if vertical_coordinate %}
    <div class="emd-meta-item">
        <span class="emd-meta-label">Vertical Coordinate</span>
        <span class="emd-meta-value" title="{{ vertical_coordinate.description | e }}">{{ vertical_coordinate.name | e }}</span>
    </div>
    {% endif %}
    {% if n_z %}
    <div class="emd-meta-item">
        <span class="emd-meta-label">Levels (n_z)</span>
        <span class="emd-meta-value">{{ n_z }}</span>
    </div>
    {% endif %}
    <div class="emd-meta-item">
        <span class="emd-meta-label">Registry</span>
        <span class="emd-meta-value"><a href="{{ context_url | e }}" target="_blank">JSON-LD →</a></span>
    </div>
</div>
{% endblock %}

{% block content %}

{# ── Plain-language summary ──────────────────────────────────────── #}
<div class="plain-summary">
    <strong>What is this?</strong>
    {% if arrangement %}
    This is a <strong>horizontal computational grid</strong> using a
    <strong>{{ arrangement.name | e }}</strong> staggering arrangement.
    {% if subgrids %}
    It contains {{ subgrids | length }} subgrid{{ 's' if subgrids|length != 1 }}.
    {% for sg in subgrids if sg.grid_cells %}
    {% if sg.grid_cells.n_cells %}
    The {{ sg.name | e }} subgrid has <strong>{{ "{:,}".format(sg.grid_cells.n_cells) }}</strong> cells
    {% if sg.grid_cells.x_resolution %} at <strong>{{ sg.grid_cells.x_resolution }}°×{{ sg.grid_cells.y_resolution }}°</strong> resolution{% endif %}.
    {% endif %}
    {% endfor %}
    {% endif %}
    {% elif n_z %}
    This is a <strong>vertical computational grid</strong>
    {% if vertical_coordinate %} using a <strong>{{ vertical_coordinate.name | e }}</strong> coordinate system{% endif %}
    with <strong>{{ n_z }} vertical levels</strong>
    {% if total_thickness %} spanning <strong>{{ "{:,.0f}".format(total_thickness) }} m</strong>{% endif %}.
    The top layer is <strong>{{ top_layer_thickness }} m</strong> thick
    {% if bottom_layer_thickness %} and the bottom layer is <strong>{{ bottom_layer_thickness }} m</strong> thick{% endif %}.
    {% else %}
    This is a <strong>{{ page_type | lower }}</strong>: {{ description | e }}
    {% endif %}
</div>

{# ════════════════════════════════════════════════════════════════
   HORIZONTAL GRID
═══════════════════════════════════════════════════════════════════ #}
{% if arrangement %}

<section class="emd-section expanded">
    <div class="emd-section-header" onclick="toggleSection(this)">
        <div class="emd-section-title-wrapper">
            <div class="emd-section-icon">{{ icons.grid | safe }}</div>
            <h2 class="emd-section-title">Staggering Arrangement</h2>
        </div>
        <div class="emd-section-toggle">{{ icons.chevron | safe }}</div>
    </div>
    <div class="emd-section-content">
        <div class="emd-section-body">
            <div class="emd-section-divider"></div>
            <div class="arr-card">
                <div class="arr-name">{{ arrangement.name | e }}</div>
                {% if arrangement.description %}
                <div class="arr-desc">{{ arrangement.description | e }}</div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

{% if subgrids %}
<section class="emd-section expanded">
    <div class="emd-section-header" onclick="toggleSection(this)">
        <div class="emd-section-title-wrapper">
            <div class="emd-section-icon">{{ icons.coupling | safe }}</div>
            <h2 class="emd-section-title">Subgrids <span class="emd-section-count">({{ subgrids | length }})</span></h2>
        </div>
        <div class="emd-section-toggle">{{ icons.chevron | safe }}</div>
    </div>
    <div class="emd-section-content">
        <div class="emd-section-body">
            <div class="emd-section-divider"></div>
            <div class="emd-domains-grid">
            {% for sg in subgrids %}
            <div class="emd-domain-card">
                <div class="emd-domain-card-header">
                    <span class="emd-domain-card-title">{{ sg.name | e }}</span>
                    <span class="emd-domain-card-type">Subgrid</span>
                </div>
                {% if sg.description %}
                <p class="emd-domain-card-description">{{ sg.description | e }}</p>
                {% endif %}
                {% if sg.variable_types %}
                <div class="tag-row">
                    {% for vt in sg.variable_types %}
                    <span class="cv-tag primary" {% if vt.description %}title="{{ vt.description | e }}"{% endif %}>{{ vt.name | e }}</span>
                    {% endfor %}
                </div>
                {% endif %}
                {% if sg.grid_cells %}
                {% set gc = sg.grid_cells %}
                <div class="gc-info">
                    <div class="gc-info-title">Grid Cells — {{ gc.name | e }}</div>
                    {% if gc.description %}
                    <p style="font-size:0.8rem;color:var(--emd-secondary);margin-bottom:0.5rem;line-height:1.5;">{{ gc.description | e }}</p>
                    {% endif %}
                    <div class="gc-stats">
                        {% if gc.n_cells %}
                        <div class="gc-stat">
                            <span class="gc-stat-label">Cells</span>
                            <span class="gc-stat-value highlight">{{ "{:,}".format(gc.n_cells) }}</span>
                        </div>
                        {% endif %}
                        {% if gc.x_resolution and gc.y_resolution %}
                        <div class="gc-stat">
                            <span class="gc-stat-label">Resolution</span>
                            <span class="gc-stat-value">{{ gc.x_resolution }}° × {{ gc.y_resolution }}°{% if gc.units %} ({{ gc.units }}){% endif %}</span>
                        </div>
                        {% endif %}
                        {% if gc.grid_type %}
                        <div class="gc-stat">
                            <span class="gc-stat-label">Grid Type</span>
                            <span class="gc-stat-value" {% if gc.grid_type.description %}title="{{ gc.grid_type.description | e }}"{% endif %}>{{ gc.grid_type.name | e }}</span>
                        </div>
                        {% endif %}
                        {% if gc.grid_mapping %}
                        <div class="gc-stat">
                            <span class="gc-stat-label">Projection</span>
                            <span class="gc-stat-value" {% if gc.grid_mapping.description %}title="{{ gc.grid_mapping.description | e }}"{% endif %}>{{ gc.grid_mapping.name | e }}</span>
                        </div>
                        {% endif %}
                        {% if gc.temporal_refinement %}
                        <div class="gc-stat">
                            <span class="gc-stat-label">Temporal</span>
                            <span class="gc-stat-value">{{ gc.temporal_refinement.name | e }}</span>
                        </div>
                        {% endif %}
                        {% if gc.southernmost_latitude is not none %}
                        <div class="gc-stat">
                            <span class="gc-stat-label">S. Limit</span>
                            <span class="gc-stat-value">{{ gc.southernmost_latitude }}°</span>
                        </div>
                        {% endif %}
                        {% if gc.westernmost_longitude is not none %}
                        <div class="gc-stat">
                            <span class="gc-stat-label">W. Limit</span>
                            <span class="gc-stat-value">{{ gc.westernmost_longitude }}°</span>
                        </div>
                        {% endif %}
                    </div>
                    {% if gc.regions %}
                    <div class="tag-row">
                        {% for r in gc.regions %}<span class="cv-tag" {% if r.description %}title="{{ r.description | e }}"{% endif %}>{{ r.name | e }}</span>{% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
            </div>
        </div>
    </div>
</section>
{% endif %}

{% endif %}

{# ════════════════════════════════════════════════════════════════
   VERTICAL GRID
═══════════════════════════════════════════════════════════════════ #}
{% if vertical_coordinate or n_z %}

{% if vertical_coordinate %}
<section class="emd-section expanded">
    <div class="emd-section-header" onclick="toggleSection(this)">
        <div class="emd-section-title-wrapper">
            <div class="emd-section-icon">{{ icons.grid | safe }}</div>
            <h2 class="emd-section-title">Vertical Coordinate System</h2>
        </div>
        <div class="emd-section-toggle">{{ icons.chevron | safe }}</div>
    </div>
    <div class="emd-section-content">
        <div class="emd-section-body">
            <div class="emd-section-divider"></div>
            <div class="arr-card">
                <div class="arr-name">{{ vertical_coordinate.name | e }}</div>
                {% if vertical_coordinate.description %}
                <div class="arr-desc">{{ vertical_coordinate.description | e }}</div>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endif %}

<section class="emd-section expanded">
    <div class="emd-section-header" onclick="toggleSection(this)">
        <div class="emd-section-title-wrapper">
            <div class="emd-section-icon">{{ icons.tech | safe }}</div>
            <h2 class="emd-section-title">Level Structure</h2>
        </div>
        <div class="emd-section-toggle">{{ icons.chevron | safe }}</div>
    </div>
    <div class="emd-section-content">
        <div class="emd-section-body">
            <div class="emd-section-divider"></div>
            {% if n_z and n_z <= 120 %}
            <div class="vg-visual">
                <div class="vg-bar-wrap" title="{{ n_z }} vertical levels">
                    {% for i in range([n_z, 80] | min) %}
                    <div class="vg-bar" style="height:{{ (8 + loop.index0 * (48 / [n_z,80]|min)) | int }}px; opacity:{{ (0.15 + loop.index0 * 0.75 / [n_z,80]|min) | round(2) }}"></div>
                    {% endfor %}
                </div>
                <div class="vg-bar-labels"><span>↑ top ({{ top_layer_thickness if top_layer_thickness else '?' }} m)</span><span>bottom ({{ bottom_layer_thickness if bottom_layer_thickness else '?' }} m) ↓</span></div>
            </div>
            {% endif %}
            <div class="level-stat-grid">
                {% if n_z %}
                <div class="level-stat">
                    <div class="level-stat-value">{{ n_z }}</div>
                    <div class="level-stat-label">Vertical Levels</div>
                </div>
                {% endif %}
                {% if top_layer_thickness is not none %}
                <div class="level-stat">
                    <div class="level-stat-value">{{ top_layer_thickness }}&thinsp;m</div>
                    <div class="level-stat-label">Top Layer</div>
                </div>
                {% endif %}
                {% if bottom_layer_thickness is not none %}
                <div class="level-stat">
                    <div class="level-stat-value">{{ bottom_layer_thickness }}&thinsp;m</div>
                    <div class="level-stat-label">Bottom Layer</div>
                </div>
                {% endif %}
                {% if total_thickness is not none %}
                <div class="level-stat">
                    <div class="level-stat-value">{{ "{:,.0f}".format(total_thickness) }}&thinsp;m</div>
                    <div class="level-stat-label">Total Depth</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

{% endif %}

{# ── Technical Details ───────────────────────────────────────────── #}
<section class="emd-section">
    <div class="emd-section-header" onclick="toggleSection(this)">
        <div class="emd-section-title-wrapper">
            <div class="emd-section-icon">{{ icons.tech | safe }}</div>
            <h2 class="emd-section-title">Technical Details</h2>
        </div>
        <div class="emd-section-toggle">{{ icons.chevron | safe }}</div>
    </div>
    <div class="emd-section-content">
        <div class="emd-section-body">
            <div class="emd-section-divider"></div>
            <div class="emd-tech-grid">
                <div class="emd-tech-item">
                    <div class="emd-tech-label">Resource Identifier (@id)</div>
                    <div class="emd-tech-value">{{ id | e }}</div>
                </div>
                <div class="emd-tech-item">
                    <div class="emd-tech-label">Validation Key</div>
                    <div class="emd-tech-value">{{ validation_key | e if validation_key else 'N/A' }}</div>
                </div>
                <div class="emd-tech-item">
                    <div class="emd-tech-label">JSON-LD Context</div>
                    <div class="emd-tech-value"><a href="{{ context_url | e }}" target="_blank">{{ context_url | replace('https://', '') | e }}</a></div>
                </div>
                <div class="emd-tech-item">
                    <div class="emd-tech-label">Resource Types</div>
                    <div class="emd-type-badges">
                        {% for t in types %}<span class="emd-type-badge">{{ t | e }}</span>{% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

{% endblock %}

{% block scripts %}
const sourceData = {{ raw_json | safe }};
document.addEventListener("copy", function(e) {
    e.preventDefault();
    e.clipboardData.setData("text/plain",
        "// JSON-LD: {{ name | e }}\n// Generated: {{ generated_date }}\n\n" +
        JSON.stringify(sourceData, null, 2));
});
{% endblock %}
