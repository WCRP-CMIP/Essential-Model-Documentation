name: test-sync-build

on:
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pages: write
  id-token: write

jobs:
  build_docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout production branch
        uses: actions/checkout@v4
        with:
          ref: production
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          set -e
          npm install -g jsonld-recursive
          pip install cmipld

      - name: Debug LDR + Python
        shell: bash
        run: |
          set -euo pipefail

          echo "# Debug Run" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "## Workspace contents" | tee -a "$GITHUB_STEP_SUMMARY"
          ls -la | tee -a "$GITHUB_STEP_SUMMARY"

          echo ""
          echo "## Starting LDR server" | tee -a "$GITHUB_STEP_SUMMARY"
          ldr server stop 2>/dev/null || true
          nohup ldr server start > ldr.log 2>&1 &
          sleep 5

          MAX_RETRIES=5
          COUNT=1
          SUCCESS=false

          while [ "$COUNT" -le "$MAX_RETRIES" ]; do
            echo ""
            echo "# Attempt $COUNT" | tee -a "$GITHUB_STEP_SUMMARY"

            echo "### LDR compact"
            if ldr compact model_family/arpege-climat.json 2>&1 | tee -a "$GITHUB_STEP_SUMMARY"; then
              echo "LDR succeeded" | tee -a "$GITHUB_STEP_SUMMARY"
            else
              echo "LDR failed" | tee -a "$GITHUB_STEP_SUMMARY"
            fi

            echo ""
            echo "### Python test"

            if python -c "import cmipld; cmipld.map_current('emd'); print(cmipld.get('emd:model_family/arpege-climat.json'))" \
              2>&1 | tee -a "$GITHUB_STEP_SUMMARY"; then
              SUCCESS=true
              break
            else
              echo "Python failed" | tee -a "$GITHUB_STEP_SUMMARY"
            fi

            COUNT=$((COUNT+1))
            echo "Retrying in 5 seconds..." | tee -a "$GITHUB_STEP_SUMMARY"
            sleep 5
          done

          if [ "$SUCCESS" = false ]; then
            echo ""
            echo "## ❌ All attempts failed" | tee -a "$GITHUB_STEP_SUMMARY"
            echo "### LDR log" | tee -a "$GITHUB_STEP_SUMMARY"
            cat ldr.log | tee -a "$GITHUB_STEP_SUMMARY"
            exit 1
          else
            echo ""
            echo "## ✅ Success after $COUNT attempt(s)" | tee -a "$GITHUB_STEP_SUMMARY"
          fi
