name: ∆ src-data
description: Sync and process data from src-data to production, then build docs

permissions:
  contents: write
  issues: write
  pages: write
  id-token: write

on:
  push:
    branches:
      - "src-data"

      - "docs"

  workflow_dispatch:

jobs:
  check_contexts:
    if: github.ref == 'refs/heads/src-data'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout src-data branch
        uses: actions/checkout@v4
        with:
          ref: src-data
          fetch-depth: 1

      - name: Check context URLs
        uses: WCRP-CMIP/CMIPLD/.github/actions/check-contexts@main

  # ── Job 1: sync data to production and commit ────────────────────────────
  sync_data:
    if: github.ref == 'refs/heads/src-data'
    runs-on: ubuntu-latest
    outputs:
      has_data_changes: ${{ steps.commit_data.outputs.has_changes }}

    steps:
      - name: Checkout production branch
        uses: actions/checkout@v4
        with:
          ref: production
          fetch-depth: 0

      - name: Fetch src-data branch
        run: git fetch origin src-data:src-data

      - name: Install CMIPLD
        run: |
          npm i -g jsonld-recursive
          pip install git+https://github.com/WCRP-CMIP/CMIPLD.git

      - name: Configure Git
        run: |
          git config user.name "cmip-ipo"
          git config user.email "actions@wcrp-cmip.org"

      - name: Clean production vocab dirs
        run: |
          cd "$GITHUB_WORKSPACE"
          shopt -s extglob dotglob
          rm -rf -- !(docs|summaries|.git|.github) || true
          echo "Cleaned production vocab dirs"

      - name: Copy data from src-data branch
        run: |
          echo "Copying vocab files from src-data..."
          git checkout origin/src-data -- . 2>/dev/null || true
          git checkout production -- .gitignore 2>/dev/null || true
          touch "$GITHUB_WORKSPACE/.nojekyll"
          echo "Files now at GITHUB_WORKSPACE:"
          ls "$GITHUB_WORKSPACE"


      - name: Generate graphs (graphify)
        run: |
          cd "$GITHUB_WORKSPACE"
          graphify --all --output-summary



      - name: Run prepublish scripts
        run: |
          cd "$GITHUB_WORKSPACE"
          if [ ! -d ".github/prepublish" ]; then
            echo "No prepublish directory"; exit 0
          fi
          for script in .github/prepublish/*.sh; do
            [ -f "$script" ] || continue
            echo "Running: $(basename $script)"
            chmod +x "$script"
            bash "$script" || echo "Script failed: $(basename $script)"
          done


      - name: Commit data to production
        id: commit_data
        run: |
          cd "$GITHUB_WORKSPACE"
          git add -A
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No data changes to commit"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git commit -m "Sync vocab data from src-data"
            git push origin production
            echo "Data committed and pushed to production"
            echo "## Data sync" >> $GITHUB_STEP_SUMMARY
            echo "Vocab data committed to production" >> $GITHUB_STEP_SUMMARY
          fi

  # ── Job 2: build docs ────────────────────────────────────────────────────

  build_docs:
    needs: sync_data
    if: ${{ !failure() && !cancelled() }}
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}

    steps:
      - name: Checkout production branch
        uses: actions/checkout@v4
        with:
          ref: production
          fetch-depth: 0

      - name: Fetch docs branch
        run: git fetch origin docs:docs

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Configure Git
        run: |
          git config user.name "cmip-ipo"
          git config user.email "actions@wcrp-cmip.org"

      - name: Copy docs source from docs branch
        run: |
          git checkout origin/docs -- src 2>/dev/null && echo "Copied src/" || echo "No src/ on docs branch"
          git checkout origin/docs -- docs 2>/dev/null && echo "Copied docs/" || true

      - name: Install dependencies
        run: |
          npm install -g jsonld-recursive
          MKDOCS_DIR="$GITHUB_WORKSPACE/src/mkdocs"
          if [ -f "$MKDOCS_DIR/requirements.txt" ]; then
            pip install -r "$MKDOCS_DIR/requirements.txt"
          else
            echo "WARNING: requirements.txt not found, using fallback"
            pip install mkdocs mkdocs-material mkdocs-shadcn mkdocs-gen-files mkdocs-literate-nav pymdown-extensions beautifulsoup4 cmipld
          fi

      - name: Pre-build diagnostics
        run: |
          echo "## Pre-build diagnostics" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** $(git -C $GITHUB_WORKSPACE rev-parse --abbrev-ref HEAD)" >> $GITHUB_STEP_SUMMARY

      - name: Build MkDocs site
        run: |
          ldr server stop 2>/dev/null || true
          ldr server start
          echo "LDR server started"

          mkdocs build -f "$GITHUB_WORKSPACE/src/mkdocs/mkdocs.yml"

          BUILD_DIR="$GITHUB_WORKSPACE/build"
          if [ ! -d "$BUILD_DIR" ]; then echo "Error: no build dir"; exit 1; fi

          rm -rf "$GITHUB_WORKSPACE/src" "$GITHUB_WORKSPACE/mkdocs"
          [ -d "$GITHUB_WORKSPACE/docs" ] && rm -rf "$GITHUB_WORKSPACE/docs"
          mv "$BUILD_DIR" "$GITHUB_WORKSPACE/docs"

      - name: Generate root redirect
        run: |
          cd "$GITHUB_WORKSPACE"
          if [ ! -f "$GITHUB_WORKSPACE/index.html" ]; then

            cat > index.html << 'REDIRECT_EOF'
<!DOCTYPE html><html lang="en"><head><meta charset="utf-8">
<meta http-equiv="refresh" content="3; url=docs/">
<title>Redirecting...</title>
<style>
  body{display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;background:#fafafa;font-family:system-ui,sans-serif;}
  .wrap{text-align:center;}
  .logo{width:120px;height:120px;animation:spin 2s linear infinite;}
  @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
  p{color:#555;margin-top:1.5rem;font-size:1.1rem;}
  a{color:#2196f3;}
</style>
</head><body><div class="wrap">
<svg class="logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 228.34 209.89"><defs><style>.c{fill:#2196f3;}</style></defs><g><path class="c" d="M89.88,117.19c.86-.86,1.89-1.56,3.08-2.05s2.43-.7,3.72-.7c1.08,0,2.05,.16,2.97,.43,.92,.32,1.78,.7,2.54,1.24s1.51,1.19,2.21,1.89l5.13-5.88c-.97-1.13-2.16-2.16-3.56-3.02-1.35-.86-2.86-1.46-4.42-1.89-1.56-.43-3.18-.65-4.86-.65-2.64,0-5.07,.43-7.28,1.35-2.21,.92-4.15,2.16-5.77,3.72-1.62,1.62-2.91,3.51-3.83,5.66-.92,2.16-1.4,4.53-1.4,7.12s.43,5.07,1.29,7.23c.86,2.21,2.1,4.1,3.72,5.72,1.62,1.62,3.51,2.86,5.72,3.72,2.21,.86,4.59,1.29,7.23,1.29,1.67,0,3.34-.22,5.02-.59,1.67-.43,3.18-.97,4.53-1.73,1.35-.7,2.48-1.56,3.29-2.48l-4.05-6.42c-.65,.65-1.35,1.24-2.16,1.78-.81,.49-1.67,.92-2.64,1.19-.97,.32-1.94,.43-3.02,.43-1.56,0-2.97-.22-4.21-.7-1.29-.49-2.37-1.13-3.24-2.05-.92-.92-1.56-1.94-2.1-3.18-.49-1.24-.76-2.59-.76-4.15s.27-2.97,.76-4.21c.54-1.13,1.24-2.16,2.1-3.08Z"/><path class="c" d="M149.49,107.32h-7.23l-10.09,16.18-9.93-16.18h-7.55v34.63h8.15v-10.79c0-3.18-.05-5.99-.22-8.31-.05-.54-.11-1.13-.16-1.67l7.82,12.35h3.29l8.09-12.52c-.05,.7-.16,1.4-.16,2.16-.16,2.37-.22,5.07-.22,8.04v10.79h8.15v-34.69h.05Z"/><polygon class="c" points="177.38 114.44 177.38 107.32 157.21 107.32 157.21 114.44 163.03 114.44 163.03 134.94 157.21 134.94 157.21 142.01 177.38 142.01 177.38 134.94 171.45 134.94 171.45 114.44 177.38 114.44"/><path class="c" d="M210.24,112.87c-1.03-1.73-2.37-3.08-4.05-4.05-1.73-.97-3.61-1.51-5.83-1.51h-14.94v34.63h8.36v-11.6h6.53c2.16,0,4.1-.49,5.83-1.51,1.73-1.03,3.08-2.43,4.05-4.21,1.03-1.78,1.51-3.78,1.51-6.04,.05-2.05-.49-3.99-1.46-5.72Zm-7.66,8.15c-.38,.65-.86,1.13-1.46,1.51-.59,.38-1.24,.54-2,.54h-5.5v-8.25h5.56c.7,0,1.4,.16,2,.49,.59,.32,1.08,.81,1.46,1.4s.54,1.29,.54,2.16c-.05,.81-.22,1.51-.59,2.16Z"/></g><g><path class="c" d="M76.64,165.19c-.11,0-.22-.01-.33-.05-30.88-8.5-52.45-36.84-52.45-68.91,0-39.41,32.06-71.47,71.47-71.47s71.47,32.06,71.47,71.47c0,.69-.56,1.25-1.25,1.25s-1.25-.56-1.25-1.25c0-38.03-30.94-68.96-68.96-68.96S26.36,58.21,26.36,96.23c0,30.94,20.81,58.29,50.61,66.49,.67,.18,1.06,.87,.87,1.54-.15,.56-.66,.92-1.21,.92Z"/><path class="c" d="M53.55,141.57c-.31,0-.62-.11-.86-.34-12.48-11.83-19.35-27.81-19.35-45,0-34.18,27.81-61.99,61.99-61.99s61.99,27.81,61.99,61.99c0,.69-.56,1.25-1.25,1.25s-1.25-.56-1.25-1.25c0-32.8-26.68-59.48-59.48-59.48s-59.48,26.68-59.48,59.48c0,16.49,6.59,31.83,18.57,43.18,.5,.48,.52,1.27,.05,1.77-.25,.26-.58,.39-.91,.39Z"/><path class="c" d="M45.81,109.34c-.57,0-1.08-.39-1.22-.96-.94-3.95-1.42-8.04-1.42-12.15,0-28.76,23.4-52.15,52.15-52.15s52.15,23.4,52.15,52.15c0,.69-.56,1.25-1.25,1.25s-1.25-.56-1.25-1.25c0-27.38-22.27-49.65-49.65-49.65s-49.65,22.27-49.65,49.65c0,3.91,.46,7.8,1.35,11.57,.16,.67-.25,1.35-.93,1.51-.1,.02-.2,.03-.29,.03Z"/><path class="c" d="M135.99,97.48c-.69,0-1.25-.56-1.25-1.25,0-21.74-17.68-39.42-39.42-39.42-8.02,0-15.73,2.39-22.31,6.92-4.4,3.03-8.09,6.84-10.96,11.34-.37,.58-1.15,.76-1.73,.38-.58-.37-.76-1.15-.38-1.73,3.05-4.79,6.97-8.84,11.65-12.06,7-4.81,15.2-7.36,23.73-7.36,23.12,0,41.93,18.81,41.93,41.93,0,.69-.56,1.25-1.25,1.25Z"/><path class="c" d="M125.66,97.48c-.69,0-1.25-.56-1.25-1.25,0-16.04-13.05-29.09-29.09-29.09-3.52,0-6.96,.62-10.22,1.85-.65,.24-1.37-.08-1.61-.73-.24-.65,.09-1.37,.73-1.61,3.55-1.33,7.28-2.01,11.1-2.01,17.42,0,31.59,14.17,31.59,31.59,0,.69-.56,1.25-1.25,1.25Z"/><path class="c" d="M115.56,97.48c-.69,0-1.25-.56-1.25-1.25,0-5.81-2.61-11.22-7.15-14.85-.54-.43-.63-1.22-.2-1.76s1.22-.63,1.76-.2c5.14,4.11,8.09,10.23,8.09,16.8,0,.69-.56,1.25-1.25,1.25Z"/><path class="c" d="M175.98,97.59h-60.42c-.69,0-1.25-.56-1.25-1.25s.56-1.25,1.25-1.25h60.42c.69,0,1.25,.56,1.25,1.25s-.56,1.25-1.25,1.25Z"/><path class="c" d="M95.53,178.31c-45.21,0-81.99-36.78-81.99-81.99S50.32,14.33,95.53,14.33s81.99,36.78,81.99,81.99c0,.69-.56,1.25-1.25,1.25s-1.25-.56-1.25-1.25c0-43.83-35.66-79.48-79.48-79.48S16.05,52.49,16.05,96.32s35.66,79.48,79.48,79.48c2.71,0,5.45-.14,8.13-.41,.7-.06,1.3,.43,1.37,1.12,.07,.69-.43,1.3-1.12,1.37-2.77,.28-5.59,.42-8.38,.42Z"/></g></svg>
<p>Redirecting to <a href="docs/">documentation</a>...</p>
</div></body></html>
REDIRECT_EOF

          fi

      - name: Check for changes
        id: check_changes
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit docs
        if: ${{ steps.check_changes.outputs.has_changes == 'true' }}
        run: |
          git commit -m "Build documentation from docs branch"
          git push origin production



  deploy:
    needs: build_docs
    if: ${{ needs.build_docs.outputs.has_changes == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: production
      - uses: actions/configure-pages@v5
      - uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
      - uses: actions/deploy-pages@v4
        id: deployment
      - name: Display URL
        run: |
          echo "## Deployed" >> $GITHUB_STEP_SUMMARY
          echo "URL: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY

